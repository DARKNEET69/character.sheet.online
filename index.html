<!DOCTYPE html>
<html lang="en">
	<head>		
		<meta charset="utf-8" />
        <title>Characters - Universal Character Sheet</title>
        <meta name="description" content="Create dynamic character sheets for any TRPG systems" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#ffffff" />
        <meta name="apple-mobile-web-app-status-bar-style" content="default" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:site" content="@site" />
        <meta name="twitter:url" content="https://darkneet69.github.io/universal-character-sheet/" />
        <meta name="twitter:title" content="Universal Character Sheet" />
        <meta name="twitter:description" content="Create dynamic character sheets for any TRPG systems" />
        <meta name="twitter:image" content="https://darkneet69.github.io/universal-character-sheet//user.png" />

        <!-- Open Graph -->
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Universal Character Sheet" />
        <meta property="og:description" content="Create dynamic character sheets for any TRPG systems" />
        <meta property="og:site_name" content="universal-character-sheet" />
        <meta property="og:url" content="https://darkneet69.github.io/universal-character-sheet/" />
        <meta property="og:image" content="https://darkneet69.github.io/universal-character-sheet//user.png" />

        <link rel="preload" href="manifest.json" />
        <link rel="manifest" href="manifest.json" />
		<link rel="stylesheet" href="styles/main-style.css" />
        <link rel="stylesheet" href="styles/native-like-experience.css" />
        <script async src="https://unpkg.com/pwacompat" crossOrigin="anonymous"></script>

        <!-- Apple touch icon -->
        <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-touch-icon_120.png" />
        <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon_180.png" />

		<script src="scripts/app.js"></script>
	</head>
	<body>
		<menu class="subbar">
			<div class="bar-button">
				<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path d="M14 24a1 1 0 0 1-.6-.2l-4-3A1 1 0 0 1 9 20v-5.62L1.984 6.487A3.9 3.9 0 0 1 4.9 0h14.2a3.9 3.9 0 0 1 2.913 6.488L15 14.38V23a1 1 0 0 1-1 1zm-3-4.5 2 1.5v-7a1 1 0 0 1 .253-.664l7.268-8.177A1.9 1.9 0 0 0 19.1 2H4.9a1.9 1.9 0 0 0-1.421 3.158l7.269 8.178A1 1 0 0 1 11 14z" fill="currentColor" data-original="#000000"></path></g></svg>
			</div>
			<div class="bar-title">
				<h1> CHARACTERS </h1>
			</div>
			<div type="button" class="bar-button" id="addCharacterButton">
				<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve"><g><path d="M23 11H13V1a1 1 0 0 0-1-1 1 1 0 0 0-1 1v10H1a1 1 0 0 0-1 1 1 1 0 0 0 1 1h10v10a1 1 0 0 0 1 1 1 1 0 0 0 1-1V13h10a1 1 0 0 0 1-1 1 1 0 0 0-1-1Z" fill="currentColor" data-original="#000000"></path></g></svg>
			</div>
        </menu>

        <main id="characterCardsContainer">			
			<template id="characterCardTemplate">
				<div type="button" class="card-block" id="characterCardBlock">
					<div class="image-container">
						<img class="character-avatar" id="characterAvatar" src="">						
					</div>
					<div class="card-text">
						<div class="card-title" id="characterName">  </div>
						<div class="card-template" id="characterSheet">  </div>
					</div>
					<div type="button" class="minor-button" id="characterCardMenu" style="position: absolute;top: 10px; right: 10px;">
						<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="15" height="15" x="0" y="0" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><circle cx="458.667" cy="256" r="53.333" fill="currentColor" data-original="#000000" class=""></circle><circle cx="256" cy="256" r="53.333" fill="currentColor" data-original="#000000" class=""></circle><circle cx="53.333" cy="256" r="53.333" fill="currentColor" data-original="#000000" class=""></circle></g></svg>
					</div>
				</div>
			</template>
        </main>

        <nav class="navbar">
            <div class="bar-button">
				<a href="index.html">
					<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path d="M7.5 13A4.5 4.5 0 1 1 12 8.5 4.505 4.505 0 0 1 7.5 13zm0-7A2.5 2.5 0 1 0 10 8.5 2.5 2.5 0 0 0 7.5 6zM15 23v-.5a7.5 7.5 0 0 0-15 0v.5a1 1 0 0 0 2 0v-.5a5.5 5.5 0 0 1 11 0v.5a1 1 0 0 0 2 0zm9-5a7 7 0 0 0-11.667-5.217 1 1 0 1 0 1.334 1.49A5 5 0 0 1 22 18a1 1 0 0 0 2 0zm-6.5-9A4.5 4.5 0 1 1 22 4.5 4.505 4.505 0 0 1 17.5 9zm0-7A2.5 2.5 0 1 0 20 4.5 2.5 2.5 0 0 0 17.5 2z" fill="currentColor" data-original="#000000" class=""></path></g></svg>
				</a>
			</div>
			<div class="bar-button">
				<a href="">
					<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve"><g><path d="M19 2h-1V1a1 1 0 0 0-2 0v1H8V1a1 1 0 0 0-2 0v1H5C2.243 2 0 4.243 0 7v12c0 2.757 2.243 5 5 5h4a1 1 0 0 0 0-2H5c-1.654 0-3-1.346-3-3v-9h21a1 1 0 0 0 1-1V7c0-2.757-2.243-5-5-5Zm3 6H2V7c0-1.654 1.346-3 3-3h14c1.654 0 3 1.346 3 3v1Zm-3.121 4.879-5.707 5.707A3.976 3.976 0 0 0 12 21.415v1.586a1 1 0 0 0 1 1h1.586a3.973 3.973 0 0 0 2.828-1.172l5.707-5.707c.567-.567.879-1.32.879-2.122s-.312-1.555-.878-2.121c-1.134-1.134-3.11-1.134-4.243 0Zm2.828 2.828-5.708 5.707a1.983 1.983 0 0 1-1.414.586h-.586v-.586c0-.534.208-1.036.586-1.414l5.708-5.707a1.023 1.023 0 0 1 1.414 0c.189.188.293.439.293.707s-.104.518-.293.707ZM5 14a1 1 0 0 1 1-1h7a1 1 0 0 1 0 2H6a1 1 0 0 1-1-1Zm6 4a1 1 0 0 1-1 1H6a1 1 0 0 1 0-2h4a1 1 0 0 1 1 1Z" fill="currentColor" data-original="#000000"></path></g></svg>
				</a>
			</div>
			<div class="bar-button">
				<a href="">
					<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve"><g><path d="M24 10a.988.988 0 0 0-.024-.217l-1.3-5.868A4.968 4.968 0 0 0 17.792 0H6.208a4.968 4.968 0 0 0-4.88 3.915L.024 9.783A.988.988 0 0 0 0 10v1a3.984 3.984 0 0 0 1 2.643V19a5.006 5.006 0 0 0 5 5h12a5.006 5.006 0 0 0 5-5v-5.357A3.984 3.984 0 0 0 24 11Zm-22 .109 1.28-5.76A2.982 2.982 0 0 1 6.208 2H7v3a1 1 0 0 0 2 0V2h6v3a1 1 0 0 0 2 0V2h.792a2.982 2.982 0 0 1 2.928 2.349l1.28 5.76V11a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2 1 1 0 0 0-2 0 2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2 1 1 0 0 0-2 0 2 2 0 0 1-2 2H4a2 2 0 0 1-2-2ZM18 22H6a3 3 0 0 1-3-3v-4.127A3.978 3.978 0 0 0 4 15h1a3.99 3.99 0 0 0 3-1.357A3.99 3.99 0 0 0 11 15h2a3.99 3.99 0 0 0 3-1.357A3.99 3.99 0 0 0 19 15h1a3.978 3.978 0 0 0 1-.127V19a3 3 0 0 1-3 3Z" fill="currentColor" data-original="#000000"></path></g></svg>
				</a>
			</div>
			<div class="bar-button">
				<a href="pages/settings/settings.html">
					<svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svgjs="http://svgjs.com/svgjs" width="512" height="512" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path d="M1 4.75h2.736a3.728 3.728 0 0 0 7.195 0H23a1 1 0 0 0 0-2H10.931a3.728 3.728 0 0 0-7.195 0H1a1 1 0 0 0 0 2ZM7.333 2a1.75 1.75 0 1 1-1.75 1.75A1.752 1.752 0 0 1 7.333 2ZM23 11h-2.736a3.727 3.727 0 0 0-7.194 0H1a1 1 0 0 0 0 2h12.07a3.727 3.727 0 0 0 7.194 0H23a1 1 0 0 0 0-2Zm-6.333 2.75a1.75 1.75 0 1 1 1.75-1.75 1.752 1.752 0 0 1-1.75 1.75ZM23 19.25H10.931a3.728 3.728 0 0 0-7.195 0H1a1 1 0 0 0 0 2h2.736a3.728 3.728 0 0 0 7.195 0H23a1 1 0 0 0 0-2ZM7.333 22a1.75 1.75 0 1 1 1.75-1.75A1.753 1.753 0 0 1 7.333 22Z" fill="currentColor" data-original="#000000"></path></g></svg>
				</a>
			</div>
        </nav>

		<dialog id="characterCardDialog">
			<div style="display: flex; flex-direction: column; gap: 10px;">
				<div class="card-title" id="characterName" style="text-align: center;">  </div>
				<input type="button" id="dialogClone" value="CLONE" onclick="cloneCharacter(dialogCharacter);" style="color: rgba(0, 128, 255, 0.8);">
				<input type="button" id="dialogDelete" value="DELETE" onclick="deleteCharacter(dialogCharacter.id);" style="color: rgba(255, 0, 0, 0.8);">
				<input type="button" id="dialogClose" value="CLOSE" onclick="characterCardDialog.close();">
			</div>
		</dialog>

		<script>			
			let dialogCharacter;
			let characterCardTemplate = document.getElementById("characterCardTemplate"); 
			let characterCardContainer = document.getElementById("characterCardsContainer");
			let addCharacterButton = document.getElementById("addCharacterButton");
			addCharacterButton.onclick = () => addCharacter();
			getIndexedDB(updateCharacterCardList);
			function addCharacter() {
				let characterObject = structuredClone(defaultCharacterSheet);
				characterObject.id = Date.now();
				characterObject.name = "Character " + characterObject.id % 10000;
				let transaction = db.transaction(["characterSheets"], "readwrite");
				let objectStore = transaction.objectStore("characterSheets");
				let request = objectStore.add(characterObject);
				request.onerror = function(event) {
					console.error("Error adding character: " + event.target.errorCode);
				};
				request.onsuccess = function(event) {
					console.log("Character added successfully");
					openCharacter(characterObject.id);
				};
			}
			function openCharacter(characterId){
				localStorage.setItem('selectedCharacterId', characterId);
				console.log("Open character: " + characterId);
				window.location.href = "pages/characterSheet/bio.html";
			}
			function updateCharacterCardList() {
				let transaction = db.transaction(["characterSheets"], "readonly");
				let objectStore = transaction.objectStore("characterSheets");
				let request = objectStore.getAll();
				
				request.onerror = function(event) {
					console.error("Error getting characters: " + event.target.errorCode);
				};
				request.onsuccess = function(event) {
					console.log("Characters retrieved successfully");
					characterCardContainer.innerHTML = "";
					let characters = request.result;
					characters.forEach((character) => {
						let characterCardClone = characterCardTemplate.content.firstElementChild.cloneNode(true);
						characterCardClone.querySelector("#characterName").textContent = character.name;
						characterCardClone.querySelector("#characterSheet").textContent = `${(character.sheet == "") ? "Custom sheet" : character.sheet} by ${(character.sheetAutor == "") ? "Noname" : character.sheetAutor}`;
						characterCardClone.querySelector("#characterAvatar").src = (character.avatar == "") ? "user.png" : character.avatar ;
						characterCardClone.querySelector("#characterName").addEventListener("click", () => openCharacter(character.id));
						characterCardClone.querySelector("#characterCardMenu").addEventListener("click", () => openCharacterCardMenu(character));
						characterCardContainer.appendChild(characterCardClone);
					});
				};
			}
			function openCharacterCardMenu(character) {
				dialogCharacter = character;
				let characterCardDialog = document.getElementById("characterCardDialog");
				characterCardDialog.setAttribute("characterId", character.id)
				characterCardDialog.querySelector("#characterName").textContent = character.name;
				characterCardDialog.showModal();				
			}
			function cloneCharacter(character){
				document.getElementById("characterCardDialog").close();
				let cloneCharacter = structuredClone(character);
				cloneCharacter.id = Date.now();
				cloneCharacter.name = cloneCharacter.name + " Clone";
				let transaction = db.transaction(["characterSheets"], "readwrite");
				let objectStore = transaction.objectStore("characterSheets");
				let request = objectStore.add(cloneCharacter);
				request.onerror = function(event) {
					console.error("Error clone character: " + event.target.errorCode);
				};
				request.onsuccess = function(event) {
					console.log("Character clone successfully");
					updateCharacterCardList();
				};
			}
			function deleteCharacter(characterId){
				document.getElementById("characterCardDialog").close();
				let transaction = db.transaction(["characterSheets"], "readwrite");
				let objectStore = transaction.objectStore("characterSheets");
				let request = objectStore.delete(characterId);
				request.onerror = function(event) {
					console.error("Error deleting character: " + event.target.errorCode);
				};
				request.onsuccess = function(event) {
					console.log("Character deleted successfully");
					updateCharacterCardList();
				};
			}
		</script>
	</body>
</html>